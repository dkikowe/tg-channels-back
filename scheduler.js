const cron = require("node-cron");
const mongoose = require("mongoose");
const { parseCategory } = require("./parsing_telemetr/parsing");
const Channel = require("./parsing_telemetr/models/Channels");
require("dotenv").config();

// ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº MongoDB
mongoose
  .connect(process.env.MONGODB_URL, {
    useNewUrlParser: true,
    useUnifiedTopology: true,
  })
  .then(() => {
    console.log("âœ… MongoDB Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾");

    // Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
    runTelemetrParser();

    // Cron: ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ
    cron.schedule("0 * * * *", () => {
      console.log(`ğŸ•’ CRON Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ² ${new Date().toLocaleString()}`);
      runTelemetrParser();
    });
  })
  .catch((err) => {
    console.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº MongoDB:", err.message);
    process.exit(1);
  });

async function runTelemetrParser() {
  const categories = [
    "ĞĞ¾Ğ²Ğ¾ÑÑ‚Ğ¸",
    "Ğ˜Ğ³Ñ€Ñ‹",
    "Ğ›Ğ¸Ñ‚ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°",
    "ĞœÑƒĞ·Ñ‹ĞºĞ°",
    "Ğ¤Ğ¾Ñ‚Ğ¾",
    "Ğ‘Ğ»Ğ¾Ğ³ĞµÑ€Ñ‹",
    "Ğ¥Ğ°Ğ»ÑĞ²Ğ° Ğ¸ ÑĞºĞ¸Ğ´ĞºĞ¸",
    "Ğ¡ĞµÑ€Ğ²Ğ¸ÑÑ‹",
    "Ğ–Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ñ‹Ğµ",
    "Ğ­ĞºĞ¾Ğ»Ğ¾Ğ³Ğ¸Ñ",
    "ĞŸÑƒÑ‚ĞµÑˆĞµÑÑ‚Ğ²Ğ¸Ñ",
    "Ğ®Ğ¼Ğ¾Ñ€",
    "Ğ¦Ğ¸Ñ‚Ğ°Ñ‚Ñ‹",
    "Ğ”Ğ»Ñ Ğ¼ÑƒĞ¶Ñ‡Ğ¸Ğ½",
    "ĞœĞ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹ÑÑ‹",
    "ĞĞ´Ğ½Ğ¾ÑÑ‚Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ğµ",
    "ĞŸÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ",
    "ĞŸĞ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°",
    "Ğ­Ğ·Ğ¾Ñ‚ĞµÑ€Ğ¸ĞºĞ°",
    "Ğ ÑƒĞºĞ¾Ğ´ĞµĞ»Ğ¸Ğµ",
    "Ğ¡Ğ¿Ğ¾Ñ€Ñ‚",
    "Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹",
    "ĞĞ²Ñ‚Ğ¾ Ğ¸ Ğ¼Ğ¾Ñ‚Ğ¾",
    "IT",
    "ĞšÑƒĞ»Ğ¸Ğ½Ğ°Ñ€Ğ¸Ñ",
    "ĞšÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ²Ğ°Ğ»ÑÑ‚Ñ‹",
    "ĞĞµĞ´Ğ²Ğ¸Ğ¶Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ",
    "Ğ‘Ğ¸Ğ·Ğ½ĞµÑ Ğ¸ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑÑ‹",
    "ĞšĞ°Ñ€ÑŒĞµÑ€Ğ°",
    "Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ",
    "Ğ®Ñ€Ğ¸ÑĞ¿Ñ€ÑƒĞ´ĞµĞ½Ñ†Ğ¸Ñ",
    "ĞĞ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ",
    "Ğ•Ğ“Ğ­ Ğ¸ ÑĞºĞ·Ğ°Ğ¼ĞµĞ½Ñ‹",
    "Ğ ĞµĞ»Ğ¸Ğ³Ğ¸Ñ",
    "ĞĞ°ÑƒĞºĞ° Ğ¸ Ñ‚ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸",
    "ĞŸĞ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ",
    "ĞšĞ°Ğ·Ğ°Ñ…ÑÑ‚Ğ°Ğ½ÑĞºĞ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹",
    "ĞÑ€Ğ¼ÑĞ½ÑĞºĞ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹",
    "Ğ‘ĞµĞ»Ğ¾Ñ€ÑƒÑÑĞºĞ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹",
    "ĞšĞ¸Ñ€Ğ³Ğ¸Ğ·ÑĞºĞ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹",
    "ĞœĞ¾Ğ»Ğ´Ğ°Ğ²ÑĞºĞ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹",
    "Ğ¢Ğ°Ğ´Ğ¶Ğ¸ĞºÑĞºĞ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹",
    "Ğ£Ğ·Ğ±ĞµĞºÑĞºĞ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹",
    "Ğ“Ñ€ÑƒĞ·Ğ¸Ğ½ÑĞºĞ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹",
  ];

  for (const category of categories) {
    try {
      console.log(`â³ ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸: ${category}`);
      const data = await parseCategory(category);

      let updated = 0;
      for (const channel of data) {
        const filter = { channelLink: channel.channelLink };
        const update = {
          $set: {
            ...channel,
            updatedAt: new Date(),
          },
        };
        const options = { upsert: true, new: true };
        await Channel.findOneAndUpdate(filter, update, options);
        updated++;
      }

      console.log(`âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾: ${category}, Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾/Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ ${updated}`);
    } catch (err) {
      console.error(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ "${category}":`, err.message);
    }
  }
}

// Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ
runTelemetrParser();

// Cron: ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ
cron.schedule("0 * * * *", () => {
  console.log(`ğŸ•’ CRON Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ² ${new Date().toLocaleString()}`);
  runTelemetrParser();
});
